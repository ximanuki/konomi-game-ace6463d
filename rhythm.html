<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#B8F0B8">
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/animations.css">
    <title>üéµ „É™„Ç∫„É†„Ç≤„Éº„É†</title>
    <style>
        body {
            background: linear-gradient(135deg, #E8F4E8 0%, #E8F4FF 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0;
            overflow: hidden;
        }

        #gameArea {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        .note {
            position: absolute;
            font-size: 48px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            animation: noteFall 3s linear;
        }

        .judge-line {
            position: absolute;
            bottom: 120px;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--primary-pink), transparent);
            box-shadow: 0 0 10px var(--primary-pink);
        }

        .tap-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 2px solid var(--primary-pink);
        }

        .judge-text {
            position: absolute;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            opacity: 0;
            animation: judgeFlash 0.5s ease;
        }

        .judge-text.perfect { color: #FFD700; }
        .judge-text.good { color: #6BCB77; }
        .judge-text.miss { color: #999; }

        .song-select {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .song-btn {
            width: 100%;
            margin: var(--spacing-sm) 0;
            padding: var(--spacing-lg);
            font-size: var(--font-lg);
        }
    </style>
</head>
<body class="no-select">
    <button class="fixed-btn back-btn" onclick="location.href='./index.html'" aria-label="„ÇÇ„Å©„Çã">‚Üê</button>
    <button class="fixed-btn sound-btn" id="soundBtn" aria-label="„Çµ„Ç¶„É≥„Éâ">üîä</button>

    <div class="score-display" id="scoreDisplay">0</div>

    <div id="gameArea">
        <div class="judge-line"></div>
        <div class="tap-area" id="tapArea">
            <p style="font-size: 20px; color: var(--text-muted);">„Çø„ÉÉ„ÉóÔºÅ</p>
        </div>
    </div>

    <!-- Êõ≤ÈÅ∏Êäû -->
    <div class="song-select" id="songSelect">
        <h2 style="text-align: center; color: var(--primary-pink); margin-bottom: 20px;">„Åç„Çá„Åè„Çí„Åà„Çâ„Çì„Åß„Å≠</h2>
        <button class="btn btn-primary song-btn" data-song="twinkle">‚≠ê „Åç„Çâ„Åç„Çâ„Åº„Åó</button>
        <button class="btn btn-primary song-btn" data-song="butterfly">ü¶ã „Å°„Çá„ÅÜ„Å°„Çá</button>
        <button class="btn btn-primary song-btn" data-song="frog">üê∏ „Åã„Åà„Çã„ÅÆ„ÅÜ„Åü</button>
    </div>

    <script src="./js/utils.js"></script>
    <script src="./js/storage.js"></script>
    <script src="./js/sound.js"></script>
    <script src="./js/particle.js"></script>
    <script src="./js/achievements.js"></script>
    <script>
        const gameArea = document.getElementById('gameArea');
        const tapArea = document.getElementById('tapArea');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const songSelect = document.getElementById('songSelect');
        const soundBtn = document.getElementById('soundBtn');

        // „Çµ„Ç¶„É≥„ÉâË®≠ÂÆö
        gameSound.enabled = GameSettings.getSoundEnabled();
        soundBtn.textContent = gameSound.enabled ? 'üîä' : 'üîá';
        soundBtn.onclick = () => {
            const enabled = gameSound.toggle();
            soundBtn.textContent = enabled ? 'üîä' : 'üîá';
            GameSettings.setSoundEnabled(enabled);
            if (enabled) gameSound.playTap();
        };

        // Êõ≤„Éá„Éº„ÇøÔºàÈü≥Á¨¶„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞Ôºâ
        const songs = {
            twinkle: {
                name: '„Åç„Çâ„Åç„Çâ„Åº„Åó',
                notes: [
                    { time: 0, emoji: '‚≠ê' },
                    { time: 0.5, emoji: '‚≠ê' },
                    { time: 1, emoji: '‚ú®' },
                    { time: 1.5, emoji: '‚ú®' },
                    { time: 2, emoji: 'üåü' },
                    { time: 2.5, emoji: 'üåü' },
                    { time: 3, emoji: '‚≠ê' },
                    { time: 4, emoji: 'üåü' },
                    { time: 4.5, emoji: 'üåü' },
                    { time: 5, emoji: '‚ú®' },
                    { time: 5.5, emoji: '‚ú®' },
                    { time: 6, emoji: '‚≠ê' },
                    { time: 6.5, emoji: '‚≠ê' },
                    { time: 7, emoji: 'üåü' }
                ]
            },
            butterfly: {
                name: '„Å°„Çá„ÅÜ„Å°„Çá',
                notes: [
                    { time: 0, emoji: 'ü¶ã' },
                    { time: 0.6, emoji: 'üå∏' },
                    { time: 1.2, emoji: 'ü¶ã' },
                    { time: 1.8, emoji: 'üå∏' },
                    { time: 2.4, emoji: 'ü¶ã' },
                    { time: 3, emoji: 'üå∏' },
                    { time: 3.6, emoji: 'ü¶ã' },
                    { time: 4.8, emoji: 'ü¶ã' },
                    { time: 5.4, emoji: 'üå∏' },
                    { time: 6, emoji: 'ü¶ã' },
                    { time: 6.6, emoji: 'üå∏' }
                ]
            },
            frog: {
                name: '„Åã„Åà„Çã„ÅÆ„ÅÜ„Åü',
                notes: [
                    { time: 0, emoji: 'üê∏' },
                    { time: 0.4, emoji: 'üê∏' },
                    { time: 0.8, emoji: 'üê∏' },
                    { time: 1.2, emoji: 'üê∏' },
                    { time: 1.6, emoji: 'üíß' },
                    { time: 2, emoji: 'üíß' },
                    { time: 2.4, emoji: 'üíß' },
                    { time: 3.2, emoji: 'üê∏' },
                    { time: 3.6, emoji: 'üê∏' },
                    { time: 4, emoji: 'üíß' },
                    { time: 4.4, emoji: 'üíß' },
                    { time: 4.8, emoji: 'üê∏' }
                ]
            }
        };

        let currentSong = null;
        let gameStartTime = 0;
        let score = 0;
        let perfectCount = 0;
        let activeNotes = [];
        let gameRunning = false;

        // Êõ≤ÈÅ∏Êäû
        document.querySelectorAll('.song-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                gameSound.playTap();
                const songId = btn.dataset.song;
                startGame(songId);
            });
        });

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame(songId) {
            currentSong = songs[songId];
            songSelect.style.display = 'none';
            score = 0;
            perfectCount = 0;
            activeNotes = [];
            gameRunning = true;
            gameStartTime = Date.now();

            scoreDisplay.textContent = score;

            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥
            showCountdown(() => {
                spawnNotes();
            });
        }

        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫
        function showCountdown(callback) {
            let count = 3;
            const countdownEl = document.createElement('div');
            countdownEl.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 80px;
                font-weight: bold;
                color: var(--primary-pink);
                z-index: 200;
            `;
            document.body.appendChild(countdownEl);

            const interval = setInterval(() => {
                if (count > 0) {
                    countdownEl.textContent = count;
                    gameSound.playTap();
                    count--;
                } else {
                    countdownEl.textContent = 'GO!';
                    gameSound.playCorrect();
                    setTimeout(() => {
                        countdownEl.remove();
                        callback();
                    }, 500);
                    clearInterval(interval);
                }
            }, 800);
        }

        // „Éé„Éº„ÉàÁîüÊàê
        function spawnNotes() {
            currentSong.notes.forEach(noteData => {
                setTimeout(() => {
                    if (!gameRunning) return;
                    createNote(noteData.emoji);
                }, noteData.time * 1000);
            });

            // Êõ≤ÁµÇ‰∫Ü
            const duration = currentSong.notes[currentSong.notes.length - 1].time + 4;
            setTimeout(() => {
                if (gameRunning) {
                    endGame();
                }
            }, duration * 1000);
        }

        // „Éé„Éº„Éà‰ΩúÊàê
        function createNote(emoji) {
            const note = document.createElement('div');
            note.className = 'note';
            note.textContent = emoji;
            note.style.left = `${Math.random() * (window.innerWidth - 60)}px`;
            note.style.top = '-60px';
            
            const noteData = {
                element: note,
                startTime: Date.now(),
                emoji: emoji
            };
            
            activeNotes.push(noteData);
            gameArea.insertBefore(note, tapArea);

            // 3ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
            setTimeout(() => {
                if (note.parentElement) {
                    note.remove();
                    activeNotes = activeNotes.filter(n => n !== noteData);
                }
            }, 3000);
        }

        // „Çø„ÉÉ„ÉóÂà§ÂÆö
        tapArea.addEventListener('click', (e) => {
            if (!gameRunning || activeNotes.length === 0) return;

            // Âà§ÂÆö„É©„Ç§„É≥‰ªòËøë„ÅÆ„Éé„Éº„Éà„ÇíÊé¢„Åô
            const judgeLine = 120; // bottom „Åã„Çâ„ÅÆË∑ùÈõ¢
            let bestNote = null;
            let minDiff = Infinity;

            activeNotes.forEach(noteData => {
                const rect = noteData.element.getBoundingClientRect();
                const noteBottom = window.innerHeight - rect.bottom;
                const diff = Math.abs(noteBottom - judgeLine);
                
                if (diff < minDiff && diff < 100) {
                    minDiff = diff;
                    bestNote = noteData;
                }
            });

            if (bestNote) {
                judge(bestNote, minDiff);
            }
        });

        // Âà§ÂÆöÔºà6Ê≠≥ÂÖêÂêë„Åë„Å´ÂØõÂÆπ„Å™Ë®≠ÂÆöÔºâ
        function judge(noteData, diff) {
            let judgeType, points;
            
            if (diff < 50) {
                judgeType = 'perfect';
                points = 10;
                perfectCount++;
                gameSound.playJudge('perfect');
            } else if (diff < 100) {
                judgeType = 'good';
                points = 5;
                gameSound.playJudge('good');
            } else {
                judgeType = 'miss';
                points = 0;
                gameSound.playJudge('miss');
            }

            score += points;
            scoreDisplay.textContent = score;

            // Âà§ÂÆö„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫
            showJudgeText(judgeType);

            // „Éé„Éº„ÉàÂâäÈô§
            noteData.element.remove();
            activeNotes = activeNotes.filter(n => n !== noteData);

            // „Ç®„Éï„Çß„ÇØ„Éà
            if (judgeType === 'perfect') {
                createSparkle(
                    noteData.element.offsetLeft + 30,
                    window.innerHeight - 120
                );
            }
        }

        // Âà§ÂÆö„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫
        function showJudgeText(type) {
            const text = document.createElement('div');
            text.className = `judge-text ${type}`;
            
            const labels = {
                perfect: 'Perfect!',
                good: 'Good!',
                miss: '...'
            };
            
            text.textContent = labels[type];
            gameArea.appendChild(text);

            setTimeout(() => text.remove(), 500);
        }

        // „Ç≤„Éº„É†ÁµÇ‰∫Ü
        function endGame() {
            gameRunning = false;
            activeNotes.forEach(n => n.element.remove());
            activeNotes = [];

            // ÂÆüÁ∏æ„ÉÅ„Çß„ÉÉ„ÇØ
            GameProgress.markCompleted('rhythm');
            const count = GameProgress.getCompletedCount('rhythm');
            
            if (count === 1 && !AchievementManager.isUnlocked('rhythm_first')) {
                AchievementManager.check('rhythm_first');
                setTimeout(() => AchievementManager.showNotification('rhythm_first'), 1000);
            }
            if (perfectCount >= 10 && !AchievementManager.isUnlocked('rhythm_perfect')) {
                AchievementManager.check('rhythm_perfect');
                setTimeout(() => AchievementManager.showNotification('rhythm_perfect'), 1500);
            }
            if (score >= 90 && !AchievementManager.isUnlocked('rhythm_high')) {
                AchievementManager.check('rhythm_high');
                setTimeout(() => AchievementManager.showNotification('rhythm_high'), 2000);
            }

            // „ÇØ„É™„Ç¢„É¢„Éº„ÉÄ„É´
            setTimeout(() => showClearModal(score), 500);
            gameSound.playClear();
        }

        // „ÇØ„É™„Ç¢„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showClearModal(finalScore) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const stars = finalScore >= 90 ? '‚≠ê‚≠ê‚≠ê' : finalScore >= 60 ? '‚≠ê‚≠ê' : '‚≠ê';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <h2>üéµ „Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ</h2>
                <p style="font-size: 32px; margin: 20px 0;">${stars}</p>
                <p><strong>„Çπ„Ç≥„Ç¢</strong></p>
                <p style="font-size: 28px; color: var(--primary-pink); font-weight: bold; margin: 10px 0;">
                    ${finalScore} „Å¶„Çì
                </p>
                <p style="font-size: 14px; color: var(--text-muted);">
                    Perfect: ${perfectCount} „Åã„ÅÑ
                </p>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="location.reload()">
                        „ÇÇ„ÅÜ„ÅÑ„Å°„Å©
                    </button>
                    <button class="btn btn-secondary" onclick="location.href='./index.html'">
                        „ÇÇ„Å©„Çã
                    </button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        lockPortrait();
    </script>
</body>
</html>
