<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#B8F0B8">
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/animations.css">
    <title>ğŸŒ¸ ãŠã¯ãªãã ã¦</title>
    <style>
        body {
            background: linear-gradient(135deg, #E8F4E8 0%, #F4FFE8 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-md);
            padding-top: calc(var(--safe-top) + 80px);
            padding-bottom: calc(var(--safe-bottom) + var(--spacing-md));
        }

        .garden {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .planter {
            width: 100px;
            height: 140px;
            background: linear-gradient(135deg, #D2A679 0%, #A67C52 100%);
            border-radius: var(--radius-md);
            border: 3px solid #8B6F47;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: var(--spacing-sm);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .planter:active {
            transform: scale(0.95);
        }

        .planter.empty::after {
            content: 'â•';
            font-size: 32px;
            color: #666;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .flower {
            font-size: 60px;
            animation: float 3s ease-in-out infinite;
            margin-bottom: var(--spacing-sm);
        }

        .growth-bar {
            width: 80%;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: var(--spacing-xs);
        }

        .growth-fill {
            height: 100%;
            background: var(--primary-green);
            transition: width 0.5s ease;
        }

        .water-btn {
            background: linear-gradient(135deg, #4D96FF 0%, #6BB6FF 100%);
            color: white;
            margin-bottom: var(--spacing-md);
        }

        .seed-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            max-width: 300px;
        }

        .seed-btn {
            aspect-ratio: 1;
            font-size: 32px;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .seed-btn:active {
            transform: scale(0.9);
        }

        .seed-btn.locked {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .stats {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-md);
            width: 100%;
            max-width: 320px;
            text-align: center;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-top: var(--spacing-sm);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: var(--font-xl);
            font-weight: bold;
            color: var(--primary-green);
        }

        .stat-label {
            font-size: var(--font-xs);
            color: var(--text-muted);
        }
    </style>
</head>
<body class="no-select">
    <button class="fixed-btn back-btn" onclick="location.href='./index.html'" aria-label="ã‚‚ã©ã‚‹">â†</button>
    <button class="fixed-btn sound-btn" id="soundBtn" aria-label="ã‚µã‚¦ãƒ³ãƒ‰">ğŸ”Š</button>

    <h2 style="color: var(--primary-green); margin-bottom: 20px;">ğŸŒ¸ ãŠã¯ãªãã ã¦</h2>

    <div class="garden" id="garden"></div>

    <button class="btn water-btn" id="waterBtn">
        ğŸ’§ ãŠã¿ãšã‚’ã‚ã’ã‚‹
    </button>

    <div class="seed-selector" id="seedSelector"></div>

    <div class="stats">
        <h3 style="color: var(--primary-green); margin-bottom: 10px;">ğŸ“Š ã¨ã†ã‘ã„</h3>
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-value" id="harvestedCount">0</div>
                <div class="stat-label">ã—ã‚…ã†ã‹ã</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="speciesCount">0</div>
                <div class="stat-label">ã—ã‚…ã‚‹ã„</div>
            </div>
        </div>
    </div>

    <script src="./js/utils.js"></script>
    <script src="./js/storage.js"></script>
    <script src="./js/sound.js"></script>
    <script src="./js/particle.js"></script>
    <script src="./js/achievements.js"></script>
    <script>
        const gardenEl = document.getElementById('garden');
        const seedSelector = document.getElementById('seedSelector');
        const waterBtn = document.getElementById('waterBtn');
        const soundBtn = document.getElementById('soundBtn');
        const harvestedCountEl = document.getElementById('harvestedCount');
        const speciesCountEl = document.getElementById('speciesCount');

        // ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š
        gameSound.enabled = GameSettings.getSoundEnabled();
        soundBtn.textContent = gameSound.enabled ? 'ğŸ”Š' : 'ğŸ”‡';
        soundBtn.onclick = () => {
            const enabled = gameSound.toggle();
            soundBtn.textContent = enabled ? 'ğŸ”Š' : 'ğŸ”‡';
            GameSettings.setSoundEnabled(enabled);
            if (enabled) gameSound.playTap();
        };

        // èŠ±ãƒ‡ãƒ¼ã‚¿
        const flowerTypes = {
            sakura: { emoji: 'ğŸŒ¸', name: 'ã•ãã‚‰', unlocked: true },
            tulip: { emoji: 'ğŸŒ·', name: 'ãƒãƒ¥ãƒ¼ãƒªãƒƒãƒ—', unlocked: true },
            sunflower: { emoji: 'ğŸŒ»', name: 'ã²ã¾ã‚ã‚Š', unlocked: false },
            rose: { emoji: 'ğŸŒ¹', name: 'ãƒãƒ©', unlocked: false },
            bouquet: { emoji: 'ğŸ’', name: 'ãƒ–ãƒ¼ã‚±', unlocked: false }
        };

        // æˆé•·æ®µéš
        const growthStages = {
            0: 'ğŸŒ±',  // èŠ½
            33: 'ğŸŒ¿', // è‘‰
            66: 'ğŸŒ¸', // é–‹èŠ±ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€å¾Œã§å¤‰æ›´ï¼‰
            100: 'ğŸŒ¸' // å®Œå…¨é–‹èŠ±
        };

        const MAX_PLANTERS = 3;
        let planters = [];
        let selectedPlanter = null;
        let selectedSeed = null;
        let harvested = loadData('konomi_harvested', {});

        // åˆæœŸåŒ–
        function init() {
            // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’åæ˜ 
            const unlocks = loadData(STORAGE_KEYS.UNLOCKS, {});
            if (unlocks.flowers) {
                unlocks.flowers.forEach(id => {
                    if (flowerTypes[id]) {
                        flowerTypes[id].unlocked = true;
                    }
                });
            }

            // ãƒ—ãƒ©ãƒ³ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
            planters = loadData(STORAGE_KEYS.FLOWERS, []);
            
            // æˆé•·ãƒã‚§ãƒƒã‚¯
            planters.forEach(p => updateGrowth(p));

            renderGarden();
            renderSeedSelector();
            updateStats();
        }

        // ãƒ—ãƒ©ãƒ³ã‚¿ãƒ¼æç”»
        function renderGarden() {
            gardenEl.innerHTML = '';
            
            for (let i = 0; i < MAX_PLANTERS; i++) {
                const planter = planters[i];
                const planterEl = document.createElement('div');
                planterEl.className = planter ? 'planter' : 'planter empty';
                planterEl.dataset.index = i;

                if (planter) {
                    const flowerType = flowerTypes[planter.type];
                    const stage = getGrowthStage(planter.growth);
                    const emoji = planter.bloomed ? flowerType.emoji : stage;

                    planterEl.innerHTML = `
                        <div class="flower">${emoji}</div>
                        <div class="growth-bar">
                            <div class="growth-fill" style="width: ${planter.growth}%"></div>
                        </div>
                    `;

                    planterEl.onclick = () => {
                        if (planter.bloomed) {
                            harvest(i);
                        } else {
                            showToast('ã¾ã ã•ã„ã¦ãªã„ã‚ˆï¼ãŠã¿ãšã‚’ã‚ã’ã¦ã­');
                        }
                    };
                } else {
                    planterEl.onclick = () => {
                        selectedPlanter = i;
                        showToast('ã†ãˆãŸã„ãŸã­ã‚’ãˆã‚‰ã‚“ã§ã­');
                    };
                }

                gardenEl.appendChild(planterEl);
            }
        }

        // ç¨®é¸æŠUI
        function renderSeedSelector() {
            seedSelector.innerHTML = '';
            
            Object.entries(flowerTypes).forEach(([id, flower]) => {
                const btn = document.createElement('button');
                btn.className = flower.unlocked ? 'seed-btn' : 'seed-btn locked';
                btn.textContent = flower.emoji;
                btn.title = flower.name;
                btn.disabled = !flower.unlocked;

                if (flower.unlocked) {
                    btn.onclick = () => {
                        if (selectedPlanter !== null) {
                            plantSeed(selectedPlanter, id);
                            selectedPlanter = null;
                        } else {
                            showToast('ã†ãˆã‚‹ã°ã—ã‚‡ã‚’ãˆã‚‰ã‚“ã§ã­');
                        }
                    };
                }

                seedSelector.appendChild(btn);
            });
        }

        // ç¨®ã‚’æ¤ãˆã‚‹
        function plantSeed(index, type) {
            const newPlant = {
                id: `flower_${Date.now()}`,
                type: type,
                planted: new Date().toISOString(),
                lastWatered: null,
                growth: 0,
                bloomed: false
            };

            planters[index] = newPlant;
            savePlanters();
            renderGarden();
            gameSound.playTap();
            showToast(`${flowerTypes[type].name}ã®ãŸã­ã‚’ã†ãˆãŸã‚ˆï¼`);
        }

        // æ°´ã‚„ã‚Š
        waterBtn.onclick = () => {
            gameSound.playTap();
            
            let watered = false;
            const today = new Date().toISOString().split('T')[0];

            planters.forEach(planter => {
                if (!planter || planter.bloomed) return;

                const lastWateredDate = planter.lastWatered?.split('T')[0];
                if (lastWateredDate === today) return;

                // æ°´ã‚„ã‚Šå®Ÿè¡Œ
                planter.lastWatered = new Date().toISOString();
                planter.growth = Math.min(100, planter.growth + 33);

                if (planter.growth >= 100 && !planter.bloomed) {
                    planter.bloomed = true;
                    setTimeout(() => {
                        showBloomNotification(planter.type);
                    }, 500);
                }

                watered = true;
            });

            if (watered) {
                savePlanters();
                renderGarden();
                createHearts();
                showToast('ãŠã¿ãšã‚’ã‚ã’ãŸã‚ˆï¼ğŸ’§');
            } else {
                showToast('ãã‚‡ã†ã¯ã‚‚ã†ãŠã¿ãšã‚’ã‚ã’ãŸã‚ˆï¼');
            }
        };

        // æˆé•·æ®µéšå–å¾—
        function getGrowthStage(growth) {
            if (growth >= 66) return 'ğŸŒ¿';
            if (growth >= 33) return 'ğŸŒ¿';
            return 'ğŸŒ±';
        }

        // æˆé•·æ›´æ–°ï¼ˆæ™‚é–“çµŒéï¼‰
        function updateGrowth(planter) {
            if (!planter || planter.bloomed) return;

            const lastWatered = planter.lastWatered ? new Date(planter.lastWatered) : null;
            if (!lastWatered) return;

            const now = new Date();
            const daysSince = Math.floor((now - lastWatered) / (1000 * 60 * 60 * 24));

            // 1æ—¥1å›ã®æ°´ã‚„ã‚Šã§æˆé•·ï¼ˆè‡ªå‹•æˆé•·ã¯ãªã—ï¼‰
        }

        // é–‹èŠ±é€šçŸ¥
        function showBloomNotification(type) {
            const flower = flowerTypes[type];
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <h2>ğŸ‰ ãŠã¯ãªãŒã•ã„ãŸã‚ˆï¼</h2>
                <p style="font-size: 80px; margin: 20px 0;">${flower.emoji}</p>
                <p style="font-size: 24px; font-weight: bold; color: var(--primary-green);">
                    ${flower.name}
                </p>
                <p>ã‚¿ãƒƒãƒ—ã§ã—ã‚…ã†ã‹ãã—ã¦ã­ï¼</p>
                <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">
                    OK
                </button>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            createStars();
            gameSound.playClear();
        }

        // åç©«
        function harvest(index) {
            gameSound.playTap();
            const planter = planters[index];
            const flower = flowerTypes[planter.type];

            showConfirm(`${flower.name}ã‚’ã—ã‚…ã†ã‹ãã™ã‚‹ï¼Ÿ`, () => {
                // åç©«è¨˜éŒ²
                if (!harvested[planter.type]) {
                    harvested[planter.type] = 0;
                }
                harvested[planter.type]++;
                saveData('konomi_harvested', harvested);

                // ãƒ—ãƒ©ãƒ³ã‚¿ãƒ¼ç©ºã«ã™ã‚‹
                planters[index] = null;
                savePlanters();
                renderGarden();
                updateStats();

                // å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
                const totalHarvested = Object.values(harvested).reduce((a, b) => a + b, 0);
                
                if (totalHarvested === 1 && !AchievementManager.isUnlocked('flower_first')) {
                    AchievementManager.check('flower_first');
                    setTimeout(() => AchievementManager.showNotification('flower_first'), 500);
                }
                if (totalHarvested === 5 && !AchievementManager.isUnlocked('flower_5')) {
                    AchievementManager.check('flower_5');
                    setTimeout(() => AchievementManager.showNotification('flower_5'), 500);
                }
                if (totalHarvested === 10 && !AchievementManager.isUnlocked('flower_10')) {
                    AchievementManager.check('flower_10');
                    setTimeout(() => AchievementManager.showNotification('flower_10'), 500);
                }

                createConfetti();
                gameSound.playCorrect();
                showToast(`${flower.name}ã‚’ã—ã‚…ã†ã‹ãã—ãŸã‚ˆï¼${flower.emoji}`);
            });
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const total = Object.values(harvested).reduce((a, b) => a + b, 0);
            const species = Object.keys(harvested).length;

            harvestedCountEl.textContent = total;
            speciesCountEl.textContent = species;
        }

        // ä¿å­˜
        function savePlanters() {
            saveData(STORAGE_KEYS.FLOWERS, planters);
        }

        // åˆæœŸåŒ–
        init();
        lockPortrait();
    </script>
</body>
</html>
