<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#A8D8FF">
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/animations.css">
    <title>ğŸ¨ ãŠãˆã‹ã</title>
    <style>
        body {
            background: linear-gradient(135deg, #E8F4FF 0%, #F4E8FF 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-md);
            padding-top: calc(var(--safe-top) + 80px);
            padding-bottom: calc(var(--safe-bottom) + var(--spacing-md));
        }

        #drawCanvas {
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            background: white;
            touch-action: none;
            margin-bottom: var(--spacing-md);
        }

        .toolbar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            flex-wrap: wrap;
            justify-content: center;
            max-width: 360px;
        }

        .color-btn, .tool-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            border: 3px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .color-btn:active, .tool-btn:active {
            transform: scale(0.9);
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.1);
        }

        .tool-btn {
            background: white;
        }

        .tool-btn.active {
            background: var(--primary-pink);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            max-width: 360px;
        }

        .action-btn {
            flex: 1;
            padding: var(--spacing-md);
            font-size: var(--font-sm);
            font-weight: bold;
        }
    </style>
</head>
<body class="no-select">
    <button class="fixed-btn back-btn" onclick="location.href='./index.html'" aria-label="ã‚‚ã©ã‚‹">â†</button>
    <button class="fixed-btn sound-btn" id="soundBtn" aria-label="ã‚µã‚¦ãƒ³ãƒ‰">ğŸ”Š</button>

    <canvas id="drawCanvas" width="360" height="400"></canvas>

    <!-- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ -->
    <div class="toolbar" id="colorPalette">
        <button class="color-btn active" data-color="#FF6B6B" style="background: #FF6B6B;" title="ã‚ã‹"></button>
        <button class="color-btn" data-color="#FFA500" style="background: #FFA500;" title="ã‚ªãƒ¬ãƒ³ã‚¸"></button>
        <button class="color-btn" data-color="#FFD93D" style="background: #FFD93D;" title="ãã„ã‚"></button>
        <button class="color-btn" data-color="#6BCB77" style="background: #6BCB77;" title="ã¿ã©ã‚Š"></button>
        <button class="color-btn" data-color="#4D96FF" style="background: #4D96FF;" title="ã‚ãŠ"></button>
        <button class="color-btn" data-color="#9D4EDD" style="background: #9D4EDD;" title="ã‚€ã‚‰ã•ã"></button>
        <button class="color-btn" data-color="#000000" style="background: #000000;" title="ãã‚"></button>
        <button class="color-btn" data-color="#FFFFFF" style="background: #FFFFFF; border: 2px solid #ccc;" title="ã—ã‚"></button>
    </div>

    <!-- ãƒ„ãƒ¼ãƒ« -->
    <div class="toolbar">
        <button class="tool-btn active" data-tool="pen" title="ãƒšãƒ³">âœï¸</button>
        <button class="tool-btn" data-tool="eraser" title="ã‘ã—ã‚´ãƒ ">ğŸ—‘ï¸</button>
        <button class="tool-btn" data-size="5" title="ã»ãã„">â”</button>
        <button class="tool-btn active" data-size="10" title="ãµã¤ã†">â•</button>
        <button class="tool-btn" data-size="20" title="ãµã¨ã„">â–¬</button>
    </div>

    <!-- ã‚¹ã‚¿ãƒ³ãƒ— -->
    <div class="toolbar" id="stampPalette">
        <button class="tool-btn" data-stamp="â­" title="ã»ã—">â­</button>
        <button class="tool-btn" data-stamp="â¤ï¸" title="ãƒãƒ¼ãƒˆ">â¤ï¸</button>
        <button class="tool-btn" data-stamp="ğŸ˜Š" title="ãˆãŒãŠ">ğŸ˜Š</button>
        <button class="tool-btn" data-stamp="ğŸŒ¸" title="ã•ãã‚‰">ğŸŒ¸</button>
        <button class="tool-btn" data-stamp="ğŸ±" title="ã­ã“">ğŸ±</button>
        <button class="tool-btn" data-stamp="ğŸ" title="ã‚Šã‚“ã”">ğŸ</button>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="action-buttons">
        <button class="btn btn-secondary action-btn" id="clearBtn">ãœã‚“ã¶ã‘ã™</button>
        <button class="btn btn-primary action-btn" id="saveBtn">ã»ãã‚“</button>
    </div>

    <script src="./js/utils.js"></script>
    <script src="./js/storage.js"></script>
    <script src="./js/sound.js"></script>
    <script src="./js/particle.js"></script>
    <script src="./js/achievements.js"></script>
    <script>
        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        const soundBtn = document.getElementById('soundBtn');
        const clearBtn = document.getElementById('clearBtn');
        const saveBtn = document.getElementById('saveBtn');

        // ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š
        gameSound.enabled = GameSettings.getSoundEnabled();
        soundBtn.textContent = gameSound.enabled ? 'ğŸ”Š' : 'ğŸ”‡';
        soundBtn.onclick = () => {
            const enabled = gameSound.toggle();
            soundBtn.textContent = enabled ? 'ğŸ”Š' : 'ğŸ”‡';
            GameSettings.setSoundEnabled(enabled);
            if (enabled) gameSound.playTap();
        };

        // æç”»è¨­å®š
        let currentColor = '#FF6B6B';
        let currentSize = 10;
        let currentTool = 'pen';
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let usedColors = new Set();

        // ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ–
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // å‰å›ã®ä½œå“ã‚’å¾©å…ƒ
        const lastDrawing = GameProgress.getDrawing();
        if (lastDrawing) {
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
            };
            img.src = lastDrawing;
        }

        // ã‚«ãƒ©ãƒ¼é¸æŠ
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentColor = btn.dataset.color;
                currentTool = 'pen';
                gameSound.playTap();
            });
        });

        // ãƒ„ãƒ¼ãƒ«é¸æŠ
        document.querySelectorAll('[data-tool]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-tool]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTool = btn.dataset.tool;
                gameSound.playTap();
            });
        });

        // ã‚µã‚¤ã‚ºé¸æŠ
        document.querySelectorAll('[data-size]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-size]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSize = parseInt(btn.dataset.size);
                gameSound.playTap();
            });
        });

        // ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠ
        document.querySelectorAll('[data-stamp]').forEach(btn => {
            btn.addEventListener('click', () => {
                const stamp = btn.dataset.stamp;
                currentTool = 'stamp';
                currentStamp = stamp;
                gameSound.playTap();
            });
        });

        let currentStamp = null;

        // æç”»é–‹å§‹
        canvas.addEventListener('pointerdown', (e) => {
            const pos = getPos(e);
            const rect = canvas.getBoundingClientRect();
            lastX = pos.x - rect.left;
            lastY = pos.y - rect.top;

            if (currentTool === 'stamp' && currentStamp) {
                // ã‚¹ã‚¿ãƒ³ãƒ—é…ç½®
                ctx.font = '48px serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(currentStamp, lastX, lastY);
                gameSound.playTap();
                autoSave();
            } else {
                isDrawing = true;
                draw(lastX, lastY);
            }
        });

        // æç”»ä¸­
        canvas.addEventListener('pointermove', (e) => {
            if (!isDrawing) return;

            const pos = getPos(e);
            const rect = canvas.getBoundingClientRect();
            const x = pos.x - rect.left;
            const y = pos.y - rect.top;

            draw(x, y);
            lastX = x;
            lastY = y;
        });

        // æç”»çµ‚äº†
        canvas.addEventListener('pointerup', () => {
            if (isDrawing) {
                isDrawing = false;
                autoSave();
            }
        });

        canvas.addEventListener('pointerleave', () => {
            isDrawing = false;
        });

        // æç”»å‡¦ç†
        function draw(x, y) {
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);

            if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 20;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = currentSize;
                usedColors.add(currentColor);
            }

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
        }

        // è‡ªå‹•ä¿å­˜
        let autoSaveTimer;
        function autoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                const dataURL = canvas.toDataURL('image/png');
                GameProgress.saveDrawing(dataURL);
            }, 2000);
        }

        // å…¨æ¶ˆå»
        clearBtn.onclick = () => {
            gameSound.playTap();
            showConfirm('ã»ã‚“ã¨ã†ã« ãœã‚“ã¶ ã‘ã—ã¦ã„ã„ï¼Ÿ', () => {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                usedColors.clear();
                GameProgress.clearDrawing();
                gameSound.playTap();
            });
        };

        // ä¿å­˜
        saveBtn.onclick = () => {
            gameSound.playTap();
            const dataURL = canvas.toDataURL('image/png');
            const id = GalleryManager.save(dataURL);
            
            createSparkle(canvas.offsetLeft + canvas.width / 2, canvas.offsetTop + canvas.height / 2);
            showToast('ã•ãã²ã‚“ã‚’ ã»ãã‚“ã—ãŸã‚ˆï¼');
            
            // å…¨è‰²ä½¿ç”¨ãƒã‚§ãƒƒã‚¯
            if (usedColors.size >= 8 && !AchievementManager.isUnlocked('draw_all_colors')) {
                AchievementManager.check('draw_all_colors');
                setTimeout(() => AchievementManager.showNotification('draw_all_colors'), 500);
            }
        };

        lockPortrait();
    </script>
</body>
</html>
