<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFF4A8">
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/animations.css">
    <title>üåà „Åì„ÅÆ„Åø„Å°„ÇÉ„Çì„ÅÆ„ÅÑ„Çç„ÅÇ„Çè„Åõ„Ç≤„Éº„É†</title>
    <style>
        body {
            background: linear-gradient(135deg, #FFFACD 0%, #FFE8F5 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: calc(var(--safe-top) + 70px) var(--spacing-md) calc(var(--safe-bottom) + var(--spacing-md));
            min-height: 100vh;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .score {
            background: white;
            padding: 12px 24px;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-md);
            font-size: var(--font-xl);
            font-weight: bold;
            color: var(--primary-pink);
            margin-bottom: var(--spacing-md);
        }

        .question {
            font-size: var(--font-2xl);
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            text-align: center;
            padding: var(--spacing-md);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            max-width: 340px;
            width: 100%;
            margin-bottom: var(--spacing-lg);
        }

        .color-card {
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            border: 4px solid white;
            min-height: 150px;
        }

        .color-card:active {
            transform: scale(0.95);
        }

        .color-card.correct {
            animation: bounce 0.6s ease-out;
            border-color: #FFD700;
        }

        .color-card.wrong {
            animation: shake 0.5s ease-out;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1) translateY(-10px); }
            50% { transform: scale(1.05) translateY(-5px); }
            75% { transform: scale(1.08) translateY(-7px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-5px); }
        }

        .message {
            font-size: var(--font-lg);
            font-weight: bold;
            color: var(--primary-pink);
            text-align: center;
            min-height: 30px;
            margin-bottom: var(--spacing-md);
        }

        .difficulty-selector {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            justify-content: center;
        }

        .difficulty-btn {
            padding: 12px 20px;
            font-size: var(--font-md);
            font-weight: bold;
            background: white;
            border: 3px solid var(--primary-yellow);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
            min-height: 48px;
            color: var(--text-primary);
        }

        .difficulty-btn:active {
            transform: scale(0.95);
        }

        .difficulty-btn.active {
            background: var(--primary-yellow);
            color: var(--text-primary);
            border-color: #FFD700;
            transform: scale(1.05);
        }

        .modal-subtitle {
            font-size: var(--font-xl);
            color: var(--primary-pink);
            margin-bottom: var(--spacing-md);
        }

        .stars {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
            margin: var(--spacing-lg) 0;
        }

        .star {
            font-size: 48px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .star:nth-child(2) {
            animation-delay: 0.2s;
        }

        .star:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´Ôºà„Ç≠„É©„Ç≠„É©Ôºâ */
        .sparkle {
            position: fixed;
            pointer-events: none;
            font-size: 24px;
            animation: sparkle-fall 1s ease-out forwards;
            z-index: 1000;
        }

        @keyframes sparkle-fall {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0) rotate(0deg);
            }
            50% {
                transform: translateY(-30px) scale(1.5) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.5) rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- Âõ∫ÂÆö„Éú„Çø„É≥ -->
    <button class="fixed-btn back-btn" onclick="location.href='index.html'" aria-label="„ÇÇ„Å©„Çã">‚Üê</button>
    <button class="fixed-btn sound-btn" id="soundToggle" aria-label="„Çµ„Ç¶„É≥„ÉâÂàá„ÇäÊõø„Åà">üîä</button>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <div class="header">
        <div class="score" id="scoreDisplay">0 / 10</div>
        <div class="difficulty-selector" id="difficultySelector">
            <button class="difficulty-btn active" data-level="easy">„Åã„Çì„Åü„Çì</button>
            <button class="difficulty-btn" data-level="normal">„Åµ„Å§„ÅÜ</button>
            <button class="difficulty-btn" data-level="hard">„ÇÄ„Åö„Åã„Åó„ÅÑ</button>
        </div>
    </div>

    <div class="question" id="question">„Å©„Çå„Åå„Äå„ÅÇ„Åã„ÄçÔºü</div>

    <div class="color-grid" id="colorGrid">
        <!-- JavaScript„ÅßÁîüÊàê -->
    </div>

    <div class="message" id="message">„Åå„Çì„Å∞„Å£„Å¶ÔºÅ</div>

    <!-- „ÇØ„É™„Ç¢„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay hidden" id="clearModal">
        <div class="modal">
            <h2>üåà „ÇÑ„Å£„Åü„Å≠ÔºÅ</h2>
            <p class="modal-subtitle">„ÅÑ„Çç„Éû„Çπ„Çø„ÉºÔºÅ</p>
            <div class="stars">
                <span class="star">‚≠ê</span>
                <span class="star">‚≠ê</span>
                <span class="star">‚≠ê</span>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="restartGame()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
                <button class="btn btn-secondary" onclick="location.href='index.html'">„ÇÇ„Å©„Çã</button>
            </div>
        </div>
    </div>

    <script src="./js/sound.js"></script>
    <script src="./js/utils.js"></script>
    <script src="./js/particle.js"></script>
    <script>
        // ========== „Ç≤„Éº„É†ÂÆöÊï∞ ==========
        const COLORS = {
            easy: [
                { name: '„ÅÇ„Åã', color: '#FF4444', index: 0 },
                { name: '„ÅÇ„Åä', color: '#4488FF', index: 1 },
                { name: '„Åç„ÅÑ„Çç', color: '#FFDD44', index: 2 },
                { name: '„Åø„Å©„Çä', color: '#44DD44', index: 3 }
            ],
            normal: [
                { name: '„ÅÇ„Åã', color: '#FF4444', index: 0 },
                { name: '„ÅÇ„Åä', color: '#4488FF', index: 1 },
                { name: '„Åç„ÅÑ„Çç', color: '#FFDD44', index: 2 },
                { name: '„Åø„Å©„Çä', color: '#44DD44', index: 3 },
                { name: '„Éî„É≥„ÇØ', color: '#FF99CC', index: 4 },
                { name: '„Ç™„É¨„É≥„Ç∏', color: '#FF9944', index: 5 }
            ],
            hard: [
                { name: '„ÅÇ„Åã', color: '#FF4444', index: 0 },
                { name: '„ÅÇ„Åä', color: '#4488FF', index: 1 },
                { name: '„Åç„ÅÑ„Çç', color: '#FFDD44', index: 2 },
                { name: '„Åø„Å©„Çä', color: '#44DD44', index: 3 },
                { name: '„Éî„É≥„ÇØ', color: '#FF99CC', index: 4 },
                { name: '„Ç™„É¨„É≥„Ç∏', color: '#FF9944', index: 5 },
                { name: '„ÇÄ„Çâ„Åï„Åç', color: '#9944FF', index: 6 },
                { name: '„Å°„ÇÉ„ÅÑ„Çç', color: '#996633', index: 7 }
            ]
        };

        const TOTAL_QUESTIONS = 10;

        // ========== „Ç≤„Éº„É†Áä∂ÊÖã ==========
        let currentDifficulty = 'easy';
        let currentQuestion = 0;
        let score = 0;
        let targetColor = null;
        let isAnswering = false;

        // ========== DOMË¶ÅÁ¥† ==========
        const scoreDisplay = document.getElementById('scoreDisplay');
        const questionEl = document.getElementById('question');
        const colorGrid = document.getElementById('colorGrid');
        const messageEl = document.getElementById('message');
        const clearModal = document.getElementById('clearModal');
        const soundToggle = document.getElementById('soundToggle');
        const difficultySelector = document.getElementById('difficultySelector');

        // ========== ÂàùÊúüÂåñ ==========
        function init() {
            // Èü≥Èáè„Éú„Çø„É≥
            soundToggle.addEventListener('click', () => {
                const enabled = gameSound.toggle();
                soundToggle.textContent = enabled ? 'üîä' : 'üîá';
                gameSound.playTap();
            });

            // Èõ£ÊòìÂ∫¶ÈÅ∏Êäû
            difficultySelector.addEventListener('click', (e) => {
                if (e.target.classList.contains('difficulty-btn')) {
                    gameSound.playTap();
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂàá„ÇäÊõø„Åà
                    document.querySelectorAll('.difficulty-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Èõ£ÊòìÂ∫¶Â§âÊõ¥„Åó„Å¶„É™„Çπ„Çø„Éº„Éà
                    currentDifficulty = e.target.dataset.level;
                    restartGame();
                }
            });

            // „Ç≤„Éº„É†ÈñãÂßã
            startNewGame();
        }

        // ========== „Ç≤„Éº„É†ÈñãÂßã ==========
        function startNewGame() {
            currentQuestion = 0;
            score = 0;
            updateScore();
            nextQuestion();
        }

        // ========== Ê¨°„ÅÆÂïèÈ°å ==========
        function nextQuestion() {
            if (currentQuestion >= TOTAL_QUESTIONS) {
                // „ÇØ„É™„Ç¢
                showClearModal();
                return;
            }

            isAnswering = false;
            currentQuestion++;
            updateScore();

            // „É©„É≥„ÉÄ„É†„Å´Ëâ≤„ÇíÈÅ∏Êäû
            const colorSet = COLORS[currentDifficulty];
            targetColor = colorSet[Math.floor(Math.random() * colorSet.length)];

            // ÂïèÈ°åÊñáÊõ¥Êñ∞
            questionEl.textContent = `„Å©„Çå„Åå„Äå${targetColor.name}„ÄçÔºü`;

            // „Ç´„Éº„Éâ„Çí4Êûö„É©„É≥„ÉÄ„É†Ë°®Á§∫Ôºà„Çø„Éº„Ç≤„ÉÉ„ÉàËâ≤„ÇíÂê´„ÇÄÔºâ
            const choices = [targetColor];
            const otherColors = colorSet.filter(c => c.name !== targetColor.name);
            
            // ÊÆã„Çä„Çí„É©„É≥„ÉÄ„É†„Å´ËøΩÂä†ÔºàÈáçË§á„Å™„ÅóÔºâ
            while (choices.length < 4 && choices.length < colorSet.length) {
                const randomColor = otherColors[Math.floor(Math.random() * otherColors.length)];
                if (!choices.find(c => c.name === randomColor.name)) {
                    choices.push(randomColor);
                }
            }

            // 4ÊûöÊú™Ê∫Ä„ÅÆÂ†¥Âêà„ÅØÁπ∞„ÇäËøî„Åó
            while (choices.length < 4) {
                const randomColor = colorSet[Math.floor(Math.random() * colorSet.length)];
                choices.push(randomColor);
            }

            // „Ç∑„É£„ÉÉ„Éï„É´
            const shuffled = shuffle(choices);

            // „Ç´„Éº„ÉâÁîüÊàê
            renderCards(shuffled);

            // „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞
            updateMessage();
        }

        // ========== „Ç´„Éº„ÉâÊèèÁîª ==========
        function renderCards(colors) {
            colorGrid.innerHTML = '';
            
            colors.forEach((color, index) => {
                const card = document.createElement('div');
                card.className = 'color-card';
                card.style.backgroundColor = color.color;
                card.dataset.colorName = color.name;
                card.dataset.colorIndex = color.index;
                
                card.addEventListener('click', () => handleCardClick(card, color));
                
                colorGrid.appendChild(card);
            });
        }

        // ========== „Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ ==========
        function handleCardClick(card, color) {
            if (isAnswering) return;
            isAnswering = true;

            // Èü≥„ÇíÈ≥¥„Çâ„Åô
            gameSound.playColorNote(color.index);

            if (color.name === targetColor.name) {
                // Ê≠£Ëß£
                card.classList.add('correct');
                gameSound.playCorrect();
                score++;
                updateScore();
                
                // „Ç≠„É©„Ç≠„É©ÊºîÂá∫
                createSparkles(card);
                
                messageEl.textContent = '„Åõ„ÅÑ„Åã„ÅÑÔºÅ';
                messageEl.style.color = '#44DD44';

                // Ê¨°„ÅÆÂïèÈ°å„Å∏
                setTimeout(() => {
                    nextQuestion();
                }, 1200);
            } else {
                // ‰∏çÊ≠£Ëß£
                card.classList.add('wrong');
                vibrate('medium');
                
                messageEl.textContent = '„ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÔºÅ';
                messageEl.style.color = '#FF4444';

                // ÂÜçÊåëÊà¶ÂèØËÉΩ
                setTimeout(() => {
                    card.classList.remove('wrong');
                    isAnswering = false;
                    messageEl.textContent = '„Åå„Çì„Å∞„Å£„Å¶ÔºÅ';
                    messageEl.style.color = 'var(--primary-pink)';
                }, 600);
            }
        }

        // ========== „Çπ„Ç≥„Ç¢Êõ¥Êñ∞ ==========
        function updateScore() {
            scoreDisplay.textContent = `${score} / ${TOTAL_QUESTIONS}`;
        }

        // ========== „É°„ÉÉ„Çª„Éº„Ç∏Êõ¥Êñ∞ ==========
        function updateMessage() {
            const remaining = TOTAL_QUESTIONS - currentQuestion;
            if (remaining > 5) {
                messageEl.textContent = '„Åå„Çì„Å∞„Å£„Å¶ÔºÅ';
            } else if (remaining > 2) {
                messageEl.textContent = `„ÅÇ„Å® ${remaining} „ÇÇ„ÇìÔºÅ`;
            } else if (remaining > 0) {
                messageEl.textContent = '„ÇÇ„ÅÜ„Åô„Åì„ÅóÔºÅ';
            }
            messageEl.style.color = 'var(--primary-pink)';
        }

        // ========== „Ç≠„É©„Ç≠„É©ÊºîÂá∫ ==========
        function createSparkles(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < 8; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.textContent = '‚ú®';
                
                const angle = (Math.PI * 2 * i) / 8;
                const distance = 30;
                const x = centerX + Math.cos(angle) * distance;
                const y = centerY + Math.sin(angle) * distance;
                
                sparkle.style.left = `${x}px`;
                sparkle.style.top = `${y}px`;
                
                document.body.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 1000);
            }
        }

        // ========== „ÇØ„É™„Ç¢„É¢„Éº„ÉÄ„É´Ë°®Á§∫ ==========
        function showClearModal() {
            gameSound.playClear();
            clearModal.classList.remove('hidden');
            
            // Á¥ôÂêπÈõ™
            if (typeof createConfetti === 'function') {
                createConfetti();
            }
        }

        // ========== „É™„Çπ„Çø„Éº„Éà ==========
        function restartGame() {
            gameSound.playTap();
            clearModal.classList.add('hidden');
            startNewGame();
        }

        // ========== Ëµ∑Âãï ==========
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
