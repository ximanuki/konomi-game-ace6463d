<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ã‚¸ã‚°ã‚½ãƒ¼ãƒ‘ã‚ºãƒ« - ã“ã®ã¿ã¡ã‚ƒã‚“ã‚²ãƒ¼ãƒ </title>
  
  <!-- å…±é€šCSS -->
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/animations.css">
  
  <style>
    /* ãƒ‘ã‚ºãƒ«å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      background: var(--bg-gradient-2);
      overflow: hidden;
    }

    .puzzle-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 16px;
      height: 100vh;
      position: relative;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .puzzle-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: calc(var(--safe-top) + 16px) 0 16px;
    }

    .back-btn, .sound-btn {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      border: none;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      transition: transform 0.1s;
      background: white;
    }

    .back-btn:active, .sound-btn:active {
      transform: scale(0.95);
    }

    .sound-btn {
      background: var(--primary-pink);
    }

    .timer {
      font-size: 20px;
      font-weight: bold;
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
    }

    /* é›£æ˜“åº¦è¡¨ç¤º */
    .difficulty {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    /* ãƒ‘ã‚ºãƒ«ã‚¨ãƒªã‚¢ */
    .puzzle-area {
      position: relative;
      width: 360px;
      height: 360px;
      margin: 16px 0;
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .puzzle-canvas {
      width: 100%;
      height: 100%;
      touch-action: none;
    }

    /* ãƒ”ãƒ¼ã‚¹ */
    .puzzle-piece {
      position: absolute;
      cursor: grab;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
    }

    .puzzle-piece.dragging {
      cursor: grabbing;
      z-index: 1000;
      transform: scale(1.05);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      transition: none;
    }

    .puzzle-piece.near-target {
      box-shadow: 0 0 16px var(--primary-yellow);
    }

    .puzzle-piece.placed {
      pointer-events: none;
      border: 1px solid rgba(0, 255, 0, 0.3);
    }

    /* ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
    .restart-btn {
      margin-top: 16px;
      padding: 12px 32px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      background: linear-gradient(135deg, var(--primary-pink), #FF85B3);
      border: none;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      cursor: pointer;
      transition: transform 0.1s;
    }

    .restart-btn:active {
      transform: scale(0.95);
    }

    /* ã‚¯ãƒªã‚¢ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s;
    }

    .modal {
      background: white;
      border-radius: var(--radius-lg);
      padding: 32px;
      width: 320px;
      text-align: center;
      box-shadow: var(--shadow-lg);
      animation: bounceIn 0.6s;
    }

    .modal h2 {
      font-size: 32px;
      color: var(--primary-pink);
      margin-bottom: 16px;
    }

    .modal .time-display {
      font-size: 24px;
      font-weight: bold;
      color: var(--text-primary);
      margin: 16px 0;
      font-family: 'Courier New', monospace;
    }

    .modal .stars {
      font-size: 48px;
      margin: 16px 0;
    }

    .modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
    }

    .modal-buttons button {
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: transform 0.1s;
    }

    .modal-buttons button:active {
      transform: scale(0.95);
    }

    .modal-buttons .btn-primary {
      background: linear-gradient(135deg, var(--primary-pink), #FF85B3);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .modal-buttons .btn-secondary {
      background: white;
      color: var(--primary-pink);
      border: 2px solid var(--primary-pink);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ç”»åƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    .image-select-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .image-select-content {
      background: white;
      border-radius: var(--radius-lg);
      padding: 24px;
      width: 340px;
      text-align: center;
    }

    .image-select-content h2 {
      font-size: 24px;
      color: var(--primary-pink);
      margin-bottom: 24px;
    }

    .image-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .image-option {
      aspect-ratio: 1;
      border: 3px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      background: linear-gradient(135deg, #FFE5F1, #D4E4FF);
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
    }

    .image-option:active {
      transform: scale(0.95);
    }

    .image-option:hover {
      border-color: var(--primary-pink);
    }

    .image-option span {
      font-size: 14px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  
  <!-- ç”»åƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="image-select-modal" id="imageSelectModal">
    <div class="image-select-content">
      <h2>ãˆã‚’ãˆã‚‰ã‚“ã§ã­ï¼</h2>
      <div class="image-grid">
        <div class="image-option" data-image="cat">
          <div>ğŸ±</div>
          <span>ã­ã“</span>
        </div>
        <div class="image-option" data-image="rainbow">
          <div>ğŸŒˆ</div>
          <span>ã«ã˜</span>
        </div>
        <div class="image-option" data-image="flower">
          <div>ğŸŒ¸</div>
          <span>ãŠã¯ãª</span>
        </div>
        <div class="image-option" data-image="cake">
          <div>ğŸ°</div>
          <span>ã‚±ãƒ¼ã‚­</span>
        </div>
      </div>
    </div>
  </div>

  <div class="puzzle-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="puzzle-header">
      <button class="back-btn" id="backBtn" aria-label="ã‚‚ã©ã‚‹">â†</button>
      <div class="timer" id="timer">00:00</div>
      <button class="sound-btn" id="soundBtn" aria-label="ã‚µã‚¦ãƒ³ãƒ‰">ğŸ”Š</button>
    </div>

    <!-- é›£æ˜“åº¦ -->
    <div class="difficulty">ã€ã‹ã‚“ãŸã‚“ã€‘3Ã—3</div>

    <!-- ãƒ‘ã‚ºãƒ«ã‚¨ãƒªã‚¢ -->
    <div class="puzzle-area" id="puzzleArea">
      <!-- ãƒ”ãƒ¼ã‚¹ã¯JSã§å‹•çš„ç”Ÿæˆ -->
    </div>

    <!-- ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
    <button class="restart-btn" id="restartBtn">ğŸ”„ ã‚‚ã†ã„ã¡ã©</button>
  </div>

  <!-- å…±é€šJS -->
  <script src="js/sound.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/particle.js"></script>

  <script>
    /**
     * ã‚¸ã‚°ã‚½ãƒ¼ãƒ‘ã‚ºãƒ« - ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
     */
    
    const GRID_SIZE = 3; // 3Ã—3
    const PIECE_SIZE = 120; // 360px / 3
    const SNAP_DISTANCE = 40; // ã‚¹ãƒŠãƒƒãƒ—è·é›¢
    
    let pieces = [];
    let startTime = null;
    let timerInterval = null;
    let selectedImage = null;
    
    // ç”»åƒãƒ‡ãƒ¼ã‚¿ï¼ˆçµµæ–‡å­—ãƒ™ãƒ¼ã‚¹ï¼‰
    const images = {
      cat: {
        emoji: 'ğŸ±',
        colors: ['#FFD6E8', '#FFA8D0', '#FF7AB8', '#FFD6E8', '#FFA8D0', '#FF7AB8', '#FFD6E8', '#FFA8D0', '#FF7AB8']
      },
      rainbow: {
        emoji: 'ğŸŒˆ',
        colors: ['#FF9999', '#FFD699', '#FFFF99', '#99FF99', '#99D6FF', '#D699FF', '#FFB3E6', '#FFD699', '#FFE699']
      },
      flower: {
        emoji: 'ğŸŒ¸',
        colors: ['#FFE6F0', '#FFD6E8', '#FFC6E0', '#FFE6F0', '#FFD6E8', '#FFC6E0', '#FFE6F0', '#FFD6E8', '#FFC6E0']
      },
      cake: {
        emoji: 'ğŸ°',
        colors: ['#FFF5E6', '#FFEACC', '#FFDFB3', '#FFF5E6', '#FFEACC', '#FFDFB3', '#FFF5E6', '#FFEACC', '#FFDFB3']
      }
    };
    
    // åˆæœŸåŒ–
    function init() {
      setupEventListeners();
      showImageSelect();
    }
    
    // ç”»åƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showImageSelect() {
      const modal = document.getElementById('imageSelectModal');
      modal.style.display = 'flex';
      
      document.querySelectorAll('.image-option').forEach(option => {
        option.addEventListener('click', () => {
          gameSound.playTap();
          selectedImage = option.dataset.image;
          modal.style.display = 'none';
          startGame();
        });
      });
    }
    
    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame() {
      pieces = [];
      const puzzleArea = document.getElementById('puzzleArea');
      puzzleArea.innerHTML = '';
      
      // ãƒ”ãƒ¼ã‚¹ç”Ÿæˆ
      const imageData = images[selectedImage];
      const positions = [];
      
      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          positions.push({ row, col });
        }
      }
      
      // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      const shuffledPositions = shuffle(positions);
      
      shuffledPositions.forEach((pos, index) => {
        const piece = createPiece(index, pos.row, pos.col, imageData);
        pieces.push(piece);
        puzzleArea.appendChild(piece.element);
      });
      
      // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
      startTimer();
    }
    
    // ãƒ”ãƒ¼ã‚¹ä½œæˆ
    function createPiece(index, targetRow, targetCol, imageData) {
      const element = document.createElement('div');
      element.className = 'puzzle-piece';
      
      // åˆæœŸä½ç½®ï¼ˆãƒ©ãƒ³ãƒ€ãƒ é…ç½®ï¼‰
      const startRow = Math.floor(index / GRID_SIZE);
      const startCol = index % GRID_SIZE;
      
      // ã‚¹ã‚¿ã‚¤ãƒ«
      element.style.width = PIECE_SIZE + 'px';
      element.style.height = PIECE_SIZE + 'px';
      element.style.left = (startCol * PIECE_SIZE) + 'px';
      element.style.top = (startRow * PIECE_SIZE) + 'px';
      element.style.background = imageData.colors[targetRow * GRID_SIZE + targetCol];
      
      // çµµæ–‡å­—ã‚’ä¸­å¤®ã«é…ç½®
      const emojiSpan = document.createElement('span');
      emojiSpan.textContent = imageData.emoji;
      emojiSpan.style.cssText = `
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 80px;
        width: 100%;
        height: 100%;
        opacity: 0.8;
      `;
      element.appendChild(emojiSpan);
      
      const piece = {
        element,
        currentX: startCol * PIECE_SIZE,
        currentY: startRow * PIECE_SIZE,
        targetX: targetCol * PIECE_SIZE,
        targetY: targetRow * PIECE_SIZE,
        isPlaced: false,
        dragStartX: 0,
        dragStartY: 0,
        dragOffsetX: 0,
        dragOffsetY: 0
      };
      
      // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
      element.addEventListener('touchstart', (e) => handleDragStart(e, piece), { passive: false });
      element.addEventListener('touchmove', (e) => handleDragMove(e, piece), { passive: false });
      element.addEventListener('touchend', (e) => handleDragEnd(e, piece), { passive: false });
      
      return piece;
    }
    
    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
    function handleDragStart(e, piece) {
      if (piece.isPlaced) return;
      e.preventDefault();
      
      const touch = e.touches[0];
      piece.dragStartX = touch.clientX;
      piece.dragStartY = touch.clientY;
      piece.dragOffsetX = piece.currentX;
      piece.dragOffsetY = piece.currentY;
      
      piece.element.classList.add('dragging');
      gameSound.playTap();
    }
    
    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
    function handleDragMove(e, piece) {
      if (piece.isPlaced) return;
      e.preventDefault();
      
      const touch = e.touches[0];
      const deltaX = touch.clientX - piece.dragStartX;
      const deltaY = touch.clientY - piece.dragStartY;
      
      piece.currentX = piece.dragOffsetX + deltaX;
      piece.currentY = piece.dragOffsetY + deltaY;
      
      // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
      piece.currentX = clamp(piece.currentX, 0, 360 - PIECE_SIZE);
      piece.currentY = clamp(piece.currentY, 0, 360 - PIECE_SIZE);
      
      piece.element.style.left = piece.currentX + 'px';
      piece.element.style.top = piece.currentY + 'px';
      
      // ã‚¹ãƒŠãƒƒãƒ—åˆ¤å®šï¼ˆè¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
      const dist = distance(
        { x: piece.currentX, y: piece.currentY },
        { x: piece.targetX, y: piece.targetY }
      );
      
      if (dist < SNAP_DISTANCE) {
        piece.element.classList.add('near-target');
      } else {
        piece.element.classList.remove('near-target');
      }
    }
    
    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
    function handleDragEnd(e, piece) {
      if (piece.isPlaced) return;
      e.preventDefault();
      
      piece.element.classList.remove('dragging');
      
      // ã‚¹ãƒŠãƒƒãƒ—åˆ¤å®š
      const dist = distance(
        { x: piece.currentX, y: piece.currentY },
        { x: piece.targetX, y: piece.targetY }
      );
      
      if (dist < SNAP_DISTANCE) {
        // ã‚¹ãƒŠãƒƒãƒ—
        piece.currentX = piece.targetX;
        piece.currentY = piece.targetY;
        piece.element.style.left = piece.targetX + 'px';
        piece.element.style.top = piece.targetY + 'px';
        piece.isPlaced = true;
        piece.element.classList.add('placed');
        piece.element.classList.remove('near-target');
        
        gameSound.playSnap();
        createSparkle(
          piece.element.offsetLeft + PIECE_SIZE / 2,
          piece.element.offsetTop + PIECE_SIZE / 2 + 100
        );
        
        // å®Œæˆãƒã‚§ãƒƒã‚¯
        checkComplete();
      }
    }
    
    // å®Œæˆãƒã‚§ãƒƒã‚¯
    function checkComplete() {
      const allPlaced = pieces.every(p => p.isPlaced);
      if (allPlaced) {
        setTimeout(() => {
          stopTimer();
          showClearModal();
        }, 300);
      }
    }
    
    // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 100);
    }
    
    // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
    function updateTimer() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      document.getElementById('timer').textContent = formatTime(elapsed);
    }
    
    // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }
    
    // ã‚¯ãƒªã‚¢ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showClearModal() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      
      gameSound.playClear();
      createConfetti(document.body, 50);
      
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <h2>ğŸ‰ ã‚„ã£ãŸã­ï¼ ğŸ‰</h2>
          <div class="time-display">ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ <br>${formatTime(elapsed)}</div>
          <div class="stars">â­â­â­</div>
          <div class="modal-buttons">
            <button class="btn-primary" id="playAgainBtn">ã‚‚ã†ã„ã¡ã©</button>
            <button class="btn-secondary" id="backToMenuBtn">ã‚‚ã©ã‚‹</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('playAgainBtn').addEventListener('click', () => {
        gameSound.playTap();
        overlay.remove();
        showImageSelect();
      });
      
      document.getElementById('backToMenuBtn').addEventListener('click', () => {
        gameSound.playTap();
        window.location.href = 'index.html';
      });
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // æˆ»ã‚‹ãƒœã‚¿ãƒ³
      document.getElementById('backBtn').addEventListener('click', () => {
        gameSound.playTap();
        if (confirm('ã‚²ãƒ¼ãƒ ã‚’ã‚„ã‚ã¦ã‚‚ã©ã‚Šã¾ã™ã‹ï¼Ÿ')) {
          window.location.href = 'index.html';
        }
      });
      
      // ã‚µã‚¦ãƒ³ãƒ‰ãƒœã‚¿ãƒ³
      const soundBtn = document.getElementById('soundBtn');
      soundBtn.addEventListener('click', () => {
        const enabled = gameSound.toggle();
        soundBtn.textContent = enabled ? 'ğŸ”Š' : 'ğŸ”‡';
        gameSound.playTap();
      });
      
      // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
      document.getElementById('restartBtn').addEventListener('click', () => {
        gameSound.playTap();
        if (confirm('ã•ã„ã—ã‚‡ã‹ã‚‰ã‚„ã‚ŠãªãŠã—ã¾ã™ã‹ï¼Ÿ')) {
          stopTimer();
          showImageSelect();
        }
      });
    }
    
    // ç”»é¢å‘ãå›ºå®š
    lockPortrait();
    
    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>
